<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç”»é¢ - ãƒãƒªãƒƒã‚¸ã‚¿ã‚¤ãƒ—è¨ºæ–­</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f5f7fa; min-height: 100vh; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-box h1 { text-align: center; color: #7EB8DA; margin-bottom: 30px; font-size: 1.5rem; }
        .login-box input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 20px; }
        .login-box input:focus { outline: none; border-color: #7EB8DA; }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #7EB8DA, #F5A5B8); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .error-message { color: #e74c3c; text-align: center; margin-bottom: 15px; display: none; }
        .dashboard { display: none; }
        .header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #333; font-size: 1.3rem; }
        .header .logo { color: #7EB8DA; font-weight: bold; }
        .logout-btn { padding: 8px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .main { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card h3 { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card .value { font-size: 2.5rem; font-weight: bold; color: #333; }
        .stat-card.primary .value { color: #7EB8DA; }
        .stat-card.secondary .value { color: #F5A5B8; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h2 { color: #333; font-size: 1.1rem; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .type-stats { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .type-item { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
        .type-item .code { font-weight: bold; color: #7EB8DA; font-size: 1.1rem; }
        .type-item .count { font-size: 1.5rem; font-weight: bold; color: #333; margin: 5px 0; }
        .type-item .name { font-size: 0.8rem; color: #888; }
        .recent-list { max-height: 400px; overflow-y: auto; }
        .recent-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .recent-item .type { font-weight: bold; color: #7EB8DA; }
        .recent-item .time { color: #888; font-size: 0.85rem; }
        .no-data { text-align: center; color: #888; padding: 40px; }
        .refresh-btn { padding: 8px 20px; background: #7EB8DA; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>ğŸ” ç®¡ç†ç”»é¢ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <p class="error-message" id="errorMessage">APIã‚­ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</p>
            <input type="password" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›">
            <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>
    <div class="dashboard" id="dashboard">
        <header class="header">
            <h1><span class="logo">ãƒãƒªãƒƒã‚¸ã‚¿ã‚¤ãƒ—è¨ºæ–­</span> ç®¡ç†ç”»é¢</h1>
            <div>
                <button class="refresh-btn" onclick="loadDashboard()">ğŸ”„ æ›´æ–°</button>
                <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </header>
        <main class="main">
            <div class="stats-grid">
                <div class="stat-card primary"><h3>ğŸ“Š ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°</h3><div class="value" id="totalViews">-</div></div>
                <div class="stat-card"><h3>ğŸ“ˆ ä»Šæ—¥ã®ã‚¢ã‚¯ã‚»ã‚¹</h3><div class="value" id="todayViews">-</div></div>
                <div class="stat-card secondary"><h3>âœ… ç·è¨ºæ–­æ•°</h3><div class="value" id="totalDiagnosis">-</div></div>
                <div class="stat-card"><h3>ğŸ†• ä»Šæ—¥ã®è¨ºæ–­</h3><div class="value" id="todayDiagnosis">-</div></div>
            </div>
            <div class="card"><h2>ğŸ¯ ã‚¿ã‚¤ãƒ—åˆ¥è¨ºæ–­æ•°</h2><div class="type-stats" id="typeStats"><div class="no-data">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div></div>
            <div class="card"><h2>ğŸ• æœ€è¿‘ã®è¨ºæ–­çµæœ</h2><div class="recent-list" id="recentList"><div class="no-data">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div></div>
        </main>
    </div>
    <script>
        const API_BASE = window.location.origin;
        let apiKey = localStorage.getItem('adminApiKey') || '';
        document.addEventListener('DOMContentLoaded', () => { if (apiKey) showDashboard(); document.getElementById('apiKeyInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); }); });
        async function login() {
            const inputKey = document.getElementById('apiKeyInput').value;
            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`, { headers: { 'X-API-Key': inputKey } });
                if (response.ok) { apiKey = inputKey; localStorage.setItem('adminApiKey', apiKey); showDashboard(); }
                else { document.getElementById('errorMessage').style.display = 'block'; }
            } catch (error) { alert('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“'); }
        }
        function logout() { apiKey = ''; localStorage.removeItem('adminApiKey'); document.getElementById('loginContainer').style.display = 'flex'; document.getElementById('dashboard').style.display = 'none'; }
        function showDashboard() { document.getElementById('loginContainer').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; loadDashboard(); }
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/dashboard`, { headers: { 'X-API-Key': apiKey } });
                if (!res.ok) { if (res.status === 401) logout(); return; }
                const data = await res.json();
                document.getElementById('totalViews').textContent = data.totalViews.toLocaleString();
                document.getElementById('todayViews').textContent = data.todayViews.toLocaleString();
                document.getElementById('totalDiagnosis').textContent = data.totalDiagnosis.toLocaleString();
                document.getElementById('todayDiagnosis').textContent = data.todayDiagnosis.toLocaleString();
                renderTypeStats(data.typeStats);
                const recentRes = await fetch(`${API_BASE}/api/admin/diagnosis/recent?limit=20`, { headers: { 'X-API-Key': apiKey } });
                renderRecentList(await recentRes.json());
            } catch (error) { console.error('Error:', error); }
        }
        function renderTypeStats(stats) {
            const container = document.getElementById('typeStats');
            if (!stats || stats.length === 0) { container.innerHTML = '<div class="no-data">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
            container.innerHTML = stats.map(item => `<div class="type-item"><div class="code">${item.type_code}</div><div class="count">${item.count}</div><div class="name">${item.type_name}</div></div>`).join('');
        }
        function renderRecentList(data) {
            const container = document.getElementById('recentList');
            if (!data || data.length === 0) { container.innerHTML = '<div class="no-data">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
            container.innerHTML = data.map(item => { const date = new Date(item.created_at); return `<div class="recent-item"><div><span class="type">${item.type_code}</span> ${item.type_name}</div><div class="time">${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}</div></div>`; }).join('');
        }
    </script>
</body>
</html>
